## Chapter 05 트랜잭션과 잠금
</br>

-------------------------------------------------------------------------
## Introduction </br>

MySQL의 동시성에 영향을 미치는 요소

1) 잠금 (Lock)
2) 트랜잭션 (Transation)
3) 트랜잭션의 격리수준 (Isolation level)
</br>


## 잠금
    동시성을 제어하기 위한 기능이다.
    -> 여러 커넥션에서 동시에 동일한 자원을 요청할 경우
       순서대로 한 시점에는 하나의 커넥션만 변경할 수 있게 해준다.

## 격리수준
    하나의 트랜잭션 또는 여러 트랜잭션 간의 작업 내용을 어떻게 공유하고
    차단할 것인지를 결정하는 레벨을 의미한다.

-------------------------------------------------------------------------

### 5.1 트랜잭션

- 의미 : 데이터의 정합성을 보장하기 위한 기능
- TCL(Transaction Control Language) 
    - rollback : 논리적인 작업 셋 자체가 100% 적용되지 않음
    - commit : 논리적인 작업 셋 자체가 100% 적용
</br>

### \[MyISAM 과 InnoDB 트랜잭션 관점에서의 비교]


- MyISAM : 트랜잭션 지원되지 않아 일부가 적용
</br>
 -> 부분 업데이트 현상은 테이블 데이터의 정합성을 맞추는데 어려운 문제를 만들어낸다. 

```sql
mysql> CREATE TABLE tab_myisam ( fdpk INT NOT NULL, PRIMARY KEY(fdpk) ) ENGINE=MyISAM;
mysql> INSERT INTO tab_myisam (fdpk) VALUES (3);

mysql> INSERT INTO tab_myisam (fdpk) VALUES (1),(2),(3);
mysql> SELECT * FROM tab_myisam;
```
| fdpk |
|---|
|   1|
|   2|
|   3|

</br>

- InnoDB : 트랜잭션이 지원되어 에러발생 시 Rollback으로 전부 적용되지 않음

```sql
mysql> CREATE TABLE tab_innodb ( fdpk INT NOT NULL, PRIMARY KEY(fdpk) ) ENGINE=INNODB;
mysql> INSERT INTO tab_innodb (fdpk) VALUES (3);

mysql> INSERT INTO tab_innodb (fdpk) VALUES (1),(2),(3);
mysql> SELECT * FROM tab_innodb;
```
| fdpk |
|---|
|   3|
</br>

### \[주의사항]

- 프로그램의 코드가 DB connection을 가지고 있는 범위 최소화
- 트랜잭션 활성화된 프로그램의 범위를 최소화
- 네트워크 작업이 존재하는 경우 반드시 트랜잭션에서 배제

</br>

---
### 5.2 MySQL 엔진의 잠금

- MySQL 엔진의 잠금은 모든 스토리지 엔진에 영향도 있음
- 잠금의 종류
 1) 테이블 락 : 테이블 데이터 동기화를 위한 잠금
 2) 메타데이터 락 : 테이블의 구조를 잠금
 3) 네임드 락 : 사용자 정의 잠금
</br>

### 글로벌 락
```sql
mysql> FLUSH TABLES WITH READ LOCK
```
- 위 명령어를 사용한 글로벌 락은 MySQL서버의 모든 변경 작업을 멈춘다.

- 백업 락 도입배경
   - 트랜잭션 지원하는 InnoDB 사용하므로 모든 데이터 변경작업 중단 불필요
   - 보다 가벼운 글로벌 락 필요성 대두
   - MySQL 8.0 이후 Xtrabackup 또는 Enterprise Backup 툴의 안정적인 실행 필요
  
</br>

- 백업 락 : 테이블의 스키마, 사용자 인증 관련 정보 변경 불가
    - 데이터베이스 및 테이블 등 ㅗ든 객체 생성 및 변경, 삭제
    - REPAIR TABLE과 OPTIMIZE TABLE 명령
    - 사용자 관리 및 비밀번호 변경

```sql
mysql> LOCK INSTANCE FOR BACKUP;
mysql> UNLOCK INSTANCE;
```

### 테이블 락

- 명시적 테이블 락 : LOCK TABLES 명령어 사용
```sql
mysql> LOCK TABLES table_name [READ|WRITE];
mysql> UNLOCK TABLES;
```
- 묵시적 테이블 락 : MyISAM, MEMORY 테이블 데이터 변경 쿼리 실행 시 자동 획득

InnoDB 테이블에서는 스키마를 변경하는 DDL 수행 시에만 영향있음

</br>

### 네임드 락

- 사용자가 지정한 문자열에 대해 잠금을 설정
- GET_LOCK() 함수 사용

```sql
-- 'mylock'이라는 문자열에 대해 잠금
-- 잠금 사용 중이면 2초 대기, 이후 자동 해제
mysql> SELECT GET_LOCK('mylock',2);
-- 잠금이 설정되어 있는지 조회
mysql> SELECT IS_FREE_LOCK('mylock');
-- 잠금을 해제
mysql> SELECT RELEASE_LOCK('mylock');
-- MySQL 8.0 이후 중첩 네임드 락 설정 가능
mysql> SELECT GET_LOCK('mylock_1');
mysql> SELECT GET_LOCK('mylock_2');
-- 잠금 전부 해제
mysql> SELECT RELEASE_ALL_LOCKS();
```

</br>

### 메타데이터 락

- 데이터베이스 객체(테이블 또는 뷰)의 이름이나 구조를 변경하는 경우 사용
- 묵시적인 메타데이터 락

---
### 5.3 InnoDB 스토리지 엔진 잠금

- 스토리지 엔진 레벨의 잠금은 스토리지 엔진 간 상호 영향 없음

- 레코드 기반의 잠금 방식

</br>

### \[MySQL 서버에서 InnoDB의 잠금 정보를 진단하기]
- MySQL 서버의 information_schema 데이터베이스의 </br>
  INNODB_TRX, INNODB_LOCKS, INNODB_LOCK_WAIT 테이블 조인 </br>
  → InnoDB의 트랜잭션, InnoDB의 잠금, 잠금 대기 중인 트랜잭션의 목록을 조회 가능